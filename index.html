<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Tra cứu lương OneFit</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Giữ nguyên toàn bộ style đẹp như phiên bản trước */
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      max-width: 920px;
      margin: 40px auto;
      padding: 20px;
      background: linear-gradient(135deg, #e0f7fa, #f0f4f8);
      min-height: 100vh;
    }
    h1 { text-align: center; color: #01579b; margin-bottom: 50px; font-weight: 700; font-size: 2.5rem; }
    .employee-list { display: flex; flex-direction: column; gap: 20px; align-items: center; }
    .employee-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #01579b;
      padding: 24px;
      width: 80%;
      max-width: 500px;
      border-radius: 20px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .employee-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.35);
    }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); justify-content: center; align-items: center; animation: fadeIn 0.3s ease; z-index: 1000; }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    .modal-content {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 40px;
      border-radius: 24px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp { from {transform: translateY(50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    .close { float: right; font-size: 36px; cursor: pointer; color: #fff; opacity: 0.7; }
    .close:hover { opacity: 1; }
    input {
      width: 100%; padding: 16px; margin: 16px 0; border: none; border-radius: 12px;
      background: rgba(255, 255, 255, 0.3); font-size: 1.1rem; color: #01579b;
    }
    input::placeholder { color: rgba(1, 87, 155, 0.7); }
    button {
      background: #01579b; color: white; padding: 16px 40px; border: none; border-radius: 12px;
      font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px;
    }
    button:hover { background: #003c72; transform: scale(1.05); }
    table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: 20px; }
    th { background: #01579b; color: white; padding: 16px; text-align: left; font-weight: 600; }
    td { padding: 16px; background: rgba(255, 255, 255, 0.4); }
    tr td:first-child { border-radius: 12px 0 0 12px; }
    tr td:last-child { border-radius: 0 12px 12px 0; }
    .amount { text-align: right; font-weight: 600; color: #c62828; }
    .info { background: rgba(232, 245, 232, 0.7); padding: 20px; border-radius: 16px; margin: 20px 0; text-align: center; font-size: 1.2rem; font-weight: 600; color: #2e7d32; }
    .net-salary-row td { background: rgba(200, 230, 201, 0.9) !important; font-weight: 700; font-size: 1.3rem; }
    .net-salary-desc { color: #1b5e20; }
    .net-salary-amount { color: #1b5e20; font-size: 1.5rem; }
    .error, .no-data { background: rgba(255, 235, 238, 0.8); color: #c62828; padding: 20px; border-radius: 16px; margin: 20px 0; }
    .loading { background: rgba(227, 242, 253, 0.8); color: #1565c0; padding: 30px; border-radius: 16px; margin: 20px 0; text-align: center; font-size: 1.2rem; }
    .note { font-size: 0.95rem; color: #555; margin-top: 10px; text-align: center; }
  </style>
</head>
<body>
  <h1>Tra cứu lương OneFit</h1>
  
  <div class="employee-list" id="employeeList">
    <div class="loading">Đang tải danh sách nhân viên...</div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle" style="color:white; text-align:center; margin-bottom:20px;">Tra cứu lương</h2>
      <input type="password" id="passwordInput" placeholder="Nhập mật khẩu cá nhân">
      <input type="text" id="thangInput" placeholder="Nhập tháng (YYYYMM) - Để trống nếu xem lương tháng này">
      <div class="note">Nhấn Enter cũng xác nhận được</div>
      <button onclick="checkPassword()">XÁC NHẬN</button>
      <div id="salaryResult"></div>
    </div>
  </div>

<script>
let employees = [];
let currentEmployee = null;

// Tải danh sách nhân viên từ file JSON
async function loadEmployees() {
  try {
    const response = await fetch('employees.json');
    if (!response.ok) throw new Error('Không tìm thấy file employees.json');
    employees = await response.json();
    renderEmployees();
  } catch (err) {
    document.getElementById("employeeList").innerHTML = 
      `<div class="error">Lỗi tải danh sách nhân viên: ${err.message}<br>Vui lòng kiểm tra file employees.json có cùng thư mục không.</div>`;
  }
}

function renderEmployees() {
  const list = document.getElementById("employeeList");
  list.innerHTML = "";
  employees.forEach(emp => {
    const card = document.createElement("div");
    card.className = "employee-card";
    card.textContent = `${emp.name} ${emp.id}`;
    card.onclick = () => openModal(emp);
    list.appendChild(card);
  });
}

function openModal(emp) {
  currentEmployee = emp;
  document.getElementById("modalTitle").textContent = `Tra cứu lương: ${emp.name} ${emp.id}`;
  document.getElementById("passwordInput").value = "";
  document.getElementById("thangInput").value = "";
  document.getElementById("salaryResult").innerHTML = "";
  document.getElementById("modal").style.display = "flex";
  document.getElementById("passwordInput").focus();
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

async function checkPassword() {
  const inputPass = document.getElementById("passwordInput").value.trim();
  const thangInput = document.getElementById("thangInput").value.trim();
  const resultDiv = document.getElementById("salaryResult");

  if (inputPass !== currentEmployee.password) {
    resultDiv.innerHTML = '<div class="error">Mật khẩu sai! Thử lại.</div>';
    return;
  }

  let isCurrentMonth = (thangInput === "");
  let thangUse = "";
  let thangHienThi = "";

  if (isCurrentMonth) {
    const today = new Date();
    thangUse = today.getFullYear().toString() + String(today.getMonth() + 1).padStart(2, '0');
    thangHienThi = "Tháng hiện tại (" + thangUse.slice(4) + "/" + thangUse.slice(0,4) + ")";
  } else {
    if (!/^\d{6}$/.test(thangInput)) {
      resultDiv.innerHTML = '<div class="error">Tháng phải đúng định dạng YYYYMM (ví dụ: 202511)</div>';
      return;
    }
    thangUse = thangInput;
    thangHienThi = thangUse.slice(4) + "/" + thangUse.slice(0,4);
  }

  await fetchSalary(currentEmployee.id, isCurrentMonth, thangUse, thangHienThi);
}

async function fetchSalary(ma, isCurrentMonth, thangUse, thangHienThi) {
  const resultDiv = document.getElementById("salaryResult");
  resultDiv.innerHTML = `<div class="loading">Đang tải lương của <strong>${ma}</strong> – ${thangHienThi}...</div>`;

  let url = isCurrentMonth
    ? `https://esalary.one-fit.com/VN/Program/QueryReport/AjaxRequest.aspx?key=getsalarybyid&uid=${ma}&_=${Date.now()}`
    : `https://esalary.one-fit.com/VN/Program/QueryReport/AjaxRequest.aspx?key=gethistorysalary&uid=${ma}&dateid=${thangUse}&_=${Date.now()}`;

  const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);

  try {
    const res = await fetch(proxyUrl);
    const jsonText = await res.text();

    if (!jsonText || jsonText.trim() === "" || jsonText.includes("error")) {
      resultDiv.innerHTML = `<div class="no-data">Không có dữ liệu lương cho <strong>${thangHienThi}</strong> (có thể chưa cập nhật)</div>`;
      return;
    }

    const json = JSON.parse(jsonText);
    if (!Array.isArray(json) || json.length === 0) {
      resultDiv.innerHTML = `<div class="no-data">Chưa có dữ liệu lương cho ${thangHienThi}</div>`;
      return;
    }

    const nv = json[0];
    const ten = nv.userName || ma;
    const pb = nv.departName || "Không rõ";

    let table = `
      <div class="info">${ten} • ${ma} • ${pb} • ${thangHienThi}</div>
      <table>
        <tr><th>STT</th><th>Mã</th><th>Khoản mục</th><th style="text-align:right;">Số tiền</th></tr>
    `;

    json.forEach((item, i) => {
      const tien = parseFloat(item.amount || 0);
      const formattedTien = tien.toLocaleString("vi-VN") + " ₫";
      const isNetSalary = (item.itemCode === "D002") || (item.salaryDesc && item.salaryDesc.toLowerCase().includes("thực lĩnh"));
      const rowClass = isNetSalary ? ' class="net-salary-row"' : '';

      table += `
        <tr${rowClass}>
          <td style="text-align:center;">${i+1}</td>
          <td>${item.itemCode || ""}</td>
          <td>${item.salaryDesc || ""}</td>
          <td class="amount">${formattedTien}</td>
        </tr>
      `;
    });

    table += `</table>`;
    resultDiv.innerHTML = table;
  } catch (err) {
    resultDiv.innerHTML = `<div class="error">Lỗi kết nối. Thử lại sau.<br>Chi tiết: ${err.message}</div>`;
  }
}

// Enter key support
document.getElementById("passwordInput")?.addEventListener("keypress", e => { if (e.key === "Enter") checkPassword(); });
document.getElementById("thangInput")?.addEventListener("keypress", e => { if (e.key === "Enter") checkPassword(); });

// Khởi động
loadEmployees();
</script>
</body>
</html>
