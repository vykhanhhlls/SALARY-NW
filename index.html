<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Tra cứu lương OneFit</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome CDN cho eye icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background: linear-gradient(135deg, #e0f7fa, #f0f4f8);
      min-height: 100vh;
    }
    h1 { text-align: center; color: #01579b; margin-bottom: 40px; font-weight: 700; font-size: 2.4rem; }

    .login-container {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      margin: 0 auto;
      transition: opacity 0.4s ease;
    }

    .salary-container {
      display: none;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .close, .back-btn {
      cursor: pointer;
      font-size: 32px;
      color: #01579b;
      opacity: 0.8;
      float: right;
    }
    .close:hover, .back-btn:hover { opacity: 1; }

    input {
      width: 100%; padding: 16px; margin: 16px 0; border: none; border-radius: 12px;
      background: rgba(255, 255, 255, 0.3); font-size: 1.1rem; color: #01579b;
    }
    input::placeholder { color: rgba(1, 87, 155, 0.7); }

    /* Password wrapper với eye icon */
    .password-wrapper {
      position: relative;
      margin: 16px 0;
    }
    .password-wrapper input {
      padding-right: 50px; /* Để chỗ cho icon */
    }
    .eye-icon {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 1.4rem;
      color: #01579b;
      opacity: 0.7;
    }
    .eye-icon:hover {
      opacity: 1;
    }

    button {
      background: #01579b; color: white; padding: 16px; border: none; border-radius: 12px;
      font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px;
      width: 100%;
    }
    button:hover { background: #003c72; transform: scale(1.02); }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 12px;
      margin-top: 20px;
      font-size: 1.05rem;
      table-layout: auto;
    }
    th {
      background: #01579b;
      color: white;
      padding: 16px 20px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
    }
    td {
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.45);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 300px;
    }
    tr td:first-child { border-radius: 12px 0 0 12px; }
    tr td:last-child { border-radius: 0 12px 12px 0; }

    .amount {
      text-align: right;
      font-weight: 700;
      color: #1e88e5;
    }

    .info {
      background: rgba(232, 245, 232, 0.7);
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      color: #2e7d32;
    }

    .net-salary-row td {
      background: rgba(200, 230, 201, 0.9) !important;
      font-weight: 800;
      font-size: 1.28rem;
    }

    .error, .no-data {
      background: rgba(255, 235, 238, 0.8);
      color: #c62828;
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      text-align: center;
    }

    .loading {
      background: rgba(227, 242, 253, 0.8);
      color: #1565c0;
      padding: 30px;
      border-radius: 16px;
      margin: 20px 0;
      text-align: center;
      font-size: 1.2rem;
    }

    .note { font-size: 0.95rem; color: #555; margin-top: 10px; text-align: center; }

    @media (max-width: 768px) {
      body { padding: 15px; }
      table { font-size: 0.95rem; }
      td, th { padding: 12px 14px; }
    }
  </style>
</head>
<body>
  <h1>Tra cứu lương OneFit</h1>

  <div class="login-container" id="loginContainer">
    <h2 style="text-align:center; color:#01579b; margin-bottom:30px;">Nhập thông tin để tra cứu</h2>
    <input type="text" id="idInput" placeholder="Nhập mã thẻ nhân viên (ID)">
    
    <div class="password-wrapper">
      <input type="password" id="passwordInput" placeholder="Nhập mật khẩu cá nhân">
      <i class="fas fa-eye-slash eye-icon" id="togglePassword"></i>
    </div>

    <input type="text" id="thangInput" placeholder="Nhập tháng (YYYYMM) - Để trống nếu xem lương tháng này">
    <div class="note">Nhấn Enter hoặc nút bên dưới để xác nhận</div>
    <button onclick="checkAndFetch()">XÁC NHẬN TRA CỨU</button>
  </div>

  <div class="salary-container" id="salaryContainer">
    <span class="back-btn" onclick="backToLogin()">&larr; Quay lại</span>
    <div id="salaryResult"></div>
  </div>

<script>
// Toggle show/hide password
const togglePassword = document.getElementById("togglePassword");
const passwordInput = document.getElementById("passwordInput");

togglePassword.addEventListener("click", function () {
  const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
  passwordInput.setAttribute("type", type);
  
  // Toggle icon
  this.classList.toggle("fa-eye");
  this.classList.toggle("fa-eye-slash");
});

async function checkAndFetch() {
  const ma = document.getElementById("idInput").value.trim();
  const inputPass = document.getElementById("passwordInput").value.trim();
  const thangInput = document.getElementById("thangInput").value.trim();
  const resultDiv = document.getElementById("salaryResult");

  if (!ma || !inputPass) {
    resultDiv.innerHTML = '<div class="error">Vui lòng nhập đầy đủ Mã thẻ và Mật khẩu!</div>';
    return;
  }

  let isCurrentMonth = (thangInput === "");
  let thangUse = "";
  let thangHienThi = "";

  if (isCurrentMonth) {
    const today = new Date();
    thangUse = today.getFullYear().toString() + String(today.getMonth() + 1).padStart(2, '0');
    thangHienThi = `Tháng hiện tại (${thangUse.slice(4)}/${thangUse.slice(0,4)})`;
  } else {
    if (!/^\d{6}$/.test(thangInput)) {
      resultDiv.innerHTML = '<div class="error">Tháng phải đúng định dạng YYYYMM (ví dụ: 202602)</div>';
      return;
    }
    thangUse = thangInput;
    thangHienThi = `${thangUse.slice(4)}/${thangUse.slice(0,4)}`;
  }

  resultDiv.innerHTML = `<div class="loading">Đang tải lương của <strong>${ma}</strong> – ${thangHienThi}...</div>`;

  let url = isCurrentMonth
    ? `https://esalary.one-fit.com/VN/Program/QueryReport/AjaxRequest.aspx?key=getsalarybyid&uid=${ma}&_=${Date.now()}`
    : `https://esalary.one-fit.com/VN/Program/QueryReport/AjaxRequest.aspx?key=gethistorysalary&uid=${ma}&dateid=${thangUse}&_=${Date.now()}`;

  const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);

  try {
    const res = await fetch(proxyUrl);
    if (!res.ok) throw new Error("Lỗi kết nối đến server lương");

    const jsonText = await res.text();
    if (!jsonText || jsonText.trim() === "" || jsonText.toLowerCase().includes("error")) {
      resultDiv.innerHTML = `<div class="no-data">Không có dữ liệu lương cho ${thangHienThi} (có thể mã/mật khẩu sai hoặc chưa cập nhật)</div>`;
      return;
    }

    const json = JSON.parse(jsonText);
    if (!Array.isArray(json) || json.length === 0) {
      resultDiv.innerHTML = `<div class="no-data">Chưa có dữ liệu lương cho ${thangHienThi} hoặc thông tin không đúng</div>`;
      return;
    }

    const nv = json[0];
    const ten = nv.userName || ma;
    const pb = nv.departName || "Không rõ";

    let table = `
      <div class="info">${ten} • ${ma} • ${pb} • ${thangHienThi}</div>
      <table>
        <tr><th>STT</th><th>Mã khoản</th><th>Khoản mục</th><th style="text-align:right;">Số tiền</th></tr>
    `;

    json.forEach((item, i) => {
      const tien = parseFloat(item.amount || 0);
      const formattedTien = tien.toLocaleString("vi-VN") + " ₫";
      const isNetSalary = (item.itemCode === "D002") || (item.salaryDesc && item.salaryDesc.toLowerCase().includes("thực lĩnh"));
      const rowClass = isNetSalary ? ' class="net-salary-row"' : '';
      table += `
        <tr${rowClass}>
          <td style="text-align:center;">${i+1}</td>
          <td>${item.itemCode || ""}</td>
          <td>${item.salaryDesc || ""}</td>
          <td class="amount">${formattedTien}</td>
        </tr>
      `;
    });
    table += `</table>`;

    resultDiv.innerHTML = table;
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("salaryContainer").style.display = "block";
  } catch (err) {
    resultDiv.innerHTML = `<div class="error">Lỗi kết nối hoặc dữ liệu không hợp lệ.<br>Chi tiết: ${err.message}</div>`;
  }
}

function backToLogin() {
  document.getElementById("salaryContainer").style.display = "none";
  document.getElementById("loginContainer").style.display = "block";
  document.getElementById("salaryResult").innerHTML = "";
}

["idInput", "passwordInput", "thangInput"].forEach(id => {
  document.getElementById(id)?.addEventListener("keypress", e => {
    if (e.key === "Enter") checkAndFetch();
  });
});
</script>
</body>
</html>
