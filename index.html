<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Tra cứu lương OneFit</title>
  <style>
    body {font-family: Arial, sans-serif; max-width: 920px; margin: 40px auto; padding: 20px; background: #f5f7fa;}
    h1 {text-align: center; color: #0d47a1; margin-bottom: 40px;}
    .employee-list {display: flex; flex-direction: column; gap: 15px; align-items: center;}
    .employee-card {background: #2196f3; color: white; padding: 20px; width: 80%; max-width: 500px; border-radius: 12px; text-align: center; font-size: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
    .employee-card:hover {background: #1976d2;}
    .add-btn {background: #4caf50; margin-top: 20px;}
    .add-btn:hover {background: #388e3c;}
    .modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center;}
    .modal-content {background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; text-align: center;}
    input {width: 100%; padding: 15px; margin: 15px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 18px;}
    button {background: #0d47a1; color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 18px; cursor: pointer;}
    .close {float: right; font-size: 30px; cursor: pointer;}
    table {width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 6px 20px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden;}
    th {background: #0d47a1; color: white; padding: 16px;}
    td {padding: 14px; border-bottom: 1px solid #eee;}
    tr:nth-child(even) {background: #f9fcff;}
    .amount {text-align: right; font-weight: bold; color: #c62828;}
    .info {background: #e8f5e8; padding: 18px; border-radius: 12px; margin: 25px 0; text-align: center; font-size: 19px; font-weight: bold; color: #2e7d32;}
    .error {background: #ffebee; color: #c62828; padding: 20px; border-radius: 12px; margin: 20px 0;}
  </style>
</head>
<body>
  <h1>Tra cứu lương OneFit</h1>
  
  <div class="employee-list" id="employeeList">
    <!-- Các card sẽ được thêm bằng JS -->
  </div>

  <!-- Modal nhập mật khẩu và hiển thị kết quả -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">Nhập mật khẩu cho <span id="currentName"></span></h2>
      <input type="password" id="passwordInput" placeholder="Nhập mật khẩu cá nhân">
      <button onclick="checkPassword()">Xác nhận</button>
      <div id="salaryResult"></div>
    </div>
  </div>

<script>
// Danh sách nhân viên và mật khẩu (bạn thêm/sửa ở đây, mật khẩu ví dụ thôi, đổi thành thật)
const employees = [
  { id: "V3167859", name: "Nguyễn Thi Lan Hương", password: "matkhauA123" },
  { id: "V3113225", name: "Nguyễn Quang Anh", password: "matkhauB456" },
  { id: "V3120797", name: "Triệu Thị Lan", password: "matkhauC789" },
  // Thêm nhiều hơn: { id: "V0000004", name: "Tên D", password: "mkD" },
];

let currentEmployee = null;

// Tạo danh sách card
function renderEmployees() {
  const list = document.getElementById("employeeList");
  list.innerHTML = "";
  employees.forEach(emp => {
    const card = document.createElement("div");
    card.className = "employee-card";
    card.textContent = `${emp.name} ${emp.id}`;
    card.onclick = () => openModal(emp);
    list.appendChild(card);
  });
  
  // Thêm nút "Thêm +" nếu cần (có thể bỏ)
  const addCard = document.createElement("div");
  addCard.className = "employee-card add-btn";
  addCard.textContent = "Thêm +";
  addCard.onclick = () => alert("Chức năng thêm nhân viên mới (nếu cần phát triển thêm)");
  list.appendChild(addCard);
}

function openModal(emp) {
  currentEmployee = emp;
  document.getElementById("modalTitle").innerHTML = `Nhập mật khẩu cho <strong>${emp.name} ${emp.id}</strong>`;
  document.getElementById("currentName").textContent = `${emp.name} ${emp.id}`;
  document.getElementById("passwordInput").value = "";
  document.getElementById("salaryResult").innerHTML = "";
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

async function checkPassword() {
  const inputPass = document.getElementById("passwordInput").value;
  if (inputPass === currentEmployee.password) {
    await fetchSalary(currentEmployee.id);
  } else {
    document.getElementById("salaryResult").innerHTML = '<div class="error">Mật khẩu sai! Thử lại.</div>';
  }
}

async function fetchSalary(ma) {
  const resultDiv = document.getElementById("salaryResult");
  resultDiv.innerHTML = '<div class="loading">Đang tải lương tháng hiện tại (11/2025)...</div>';
  
  const thangUse = "202511"; // Tháng hiện tại, có thể thêm chọn tháng sau
  const url = `https://esalary.one-fit.com/VN/Program/QueryReport/AjaxRequest.aspx?key=getsalarybyid&uid=${ma}&_=${Date.now()}`;
  
  try {
    const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url);
    const res = await fetch(proxy);
    const data = await res.json();
    const jsonText = data.contents || "";
    
    if (!jsonText || jsonText.trim() === "" || jsonText.includes("error")) {
      resultDiv.innerHTML = `<div class="error">Không có dữ liệu lương (có thể chưa cập nhật)</div>`;
      return;
    }
    
    const json = JSON.parse(jsonText);
    if (!Array.isArray(json) || json.length === 0) {
      resultDiv.innerHTML = `<div class="error">Chưa có dữ liệu lương cho tháng này</div>`;
      return;
    }
    
    const nv = json[0];
    const ten = nv.userName || "Không rõ";
    const pb = nv.departName || "Không rõ";
    let tong = 0;
    
    let table = `
      <div class="info">${ten} • ${ma} • ${pb} • Tháng 11/2025</div>
      <table>
        <tr><th>STT</th><th>Mã</th><th>Khoản mục</th><th style="text-align:right;">Số tiền</th></tr>
    `;
    
    json.forEach((item, i) => {
      const tien = parseFloat(item.amount || 0);
      tong += tien;
      table += `
        <tr>
          <td style="text-align:center;">${i+1}</td>
          <td>${item.itemCode || ""}</td>
          <td>${item.salaryDesc || ""}</td>
          <td class="amount">${tien.toLocaleString("vi-VN")} ₫</td>
        </tr>
      `;
    });
    
    table += `
      </table>
      <div class="info" style="font-size:22px;">Tổng thực lãnh: ${tong.toLocaleString("vi-VN")} ₫</div>
    `;
    
    resultDiv.innerHTML = table;
  } catch (err) {
    resultDiv.innerHTML = `<div class="error">Lỗi kết nối. Thử lại sau! (${err.message})</div>`;
  }
}

// Khởi chạy
renderEmployees();
</script>
</body>
</html>
